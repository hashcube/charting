<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
<script src="js/underscore.js" type="text/javascript"></script>
<script src="js/highcharts.src.js" type="text/javascript"></script>
<title>Charting</title>
</head>
<body>

<script type='text/javascript'>
Array.prototype.min = function() {
  var min = this[0];
  for(var i=0; i < this.length; i++){
    if(this[i] < min)
      min = this[i];
  }
  return min;
}

Array.prototype.max = function() {
  var max = this[0];
  for(var i=0; i < this.length; i++){
    if(this[i] > max)
      max = this[i];
  }
  return max;
}
</script>

<script type="text/javascript">
var data = <?php echo $json_data; ?>;
$(document).ready(function() {

  var chartid = 0;
  _.each(data, function(chart) {
    chartel_id = createDiv(chartid);
    if(chart.chart_type == "pie")
      createPieChart(chartel_id, chart);
    else
      createChart(chartel_id, chart);
    //createChart(chartel_id, chart);
    chartid++;
  });
});

function createDiv(chartid) {
  var chartel_id = 'chart_'+chartid;
  var el = $("<div></div>");
  el.attr('id',chartel_id);
  el.css('margin', '20px');
  $('body').append(el);
  return chartel_id;
}

function createPieChart(el, data) {
  var chart0_info = data.charts[0];
  var series_data = Array();
  _.each(data.charts, function(d){
    var obj = {
      type : "pie",
      name: d.y_axis
    };
    var vals = Array();
    var max_pies = (d.result.x.length>20) ? 20 : d.result.x.length;
    for(var i=0; i<max_pies; i++){
      vals[i] = Array(chart0_info.result.x[i], 
                     d.result.y[i]);
    }
    obj.data = vals;
    series_data.push(obj);
  });
  var chartid = new Highcharts.Chart({
    chart: {
      renderTo: el
    },
    title: {
      text: data.title
    },
    tooltip: {
      formatter: function() {
        return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(2) +' %';
      }
    },
    plotOptions: {
      pie: {
        allowPointSelect: true,
        cursor: 'pointer',
        dataLabels: {
          enabled: true,
          formatter: function() {
            return '<b>'+ this.point.name +'</b>: '+ this.point.y;
          }
        }
      }
    },
    series: series_data
  });
  return chartid;
}

function createChart(el, data) {
  var chart0_info = data.charts[0];
  var series_data = Array();
  _.each(data.charts, function(d) {
    var obj = {
      name: d.y_axis,
      data: _.values(d.result.y)
    };
    series_data.push(obj);
  });

  var chartoptions = {
    chart: {
      renderTo: el,
      type: data.chart_type
    },
    title: {
      text: data.title
    },
    xAxis: {
      title: {
        text: data.x_axis
      },
      categories: _.values(chart0_info.result.x),
      labels: {
        rotation: -45,
        align: "right"
      }
    },
    yAxis: {
      min : findMin(series_data),
      title: {
        text: data.y_axis
      }
    },
    series: series_data
  };
  if(data.chart_type == 'stack column') {
    chartoptions.plotOptions = {
      column: {
        stacking: 'normal'
      }
    };
    chartoptions.chart.type = 'column';
  }
  var chartid = new Highcharts.Chart(chartoptions);
  
  return chartid;
}

function findMin(series){
  var Min = series[0].data.min();
  _.each(series, function(obj){
    if(obj.data.min() < Min) {
      Min = obj.data.min();
    }
  });
  return Min;
}
function findMax(series){
  var Max = series[0].data.max();
  _.each(series, function(obj){
    if(obj.data.max() > Max) {
      Max = obj.data.max();
    }
  });
  return Max;
}
</script>
<h1>Sudoku Quest</h1>
</body>
</html>
